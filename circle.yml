general:
  branches:
    only:
      - circle_ci
      - production

machine:
  timezone:
    Etc/UTC
  services:
    - docker
  environment:
    RAILS_ENV: test
    RACK_ENV: test
    NEW_RELIC_LOG: stdout
    WEB_CONCURRENCY: 3
    CXX: g++-4.8

dependencies:
  pre:
    - sudo apt-get update
    - sudo apt-get install python3-setuptools python3-dev
    - sudo easy_install3 pip
    - sudo -H pip install awsebcli
    - cd /home/ubuntu/NodeBB
    - mkdir .elasticbeanstalk
    - "echo \"branch-defaults:\" > .elasticbeanstalk/config.yml"
    - "echo \"  circle_ci:\" >> .elasticbeanstalk/config.yml"
    - "echo \"    environment: ${EB_ENVIRONMENT}\" >> .elasticbeanstalk/config.yml"
    - "echo \"global:\" >> .elasticbeanstalk/config.yml"
    - "echo \"  application_name: ${EB_APPLICATION}\" >> .elasticbeanstalk/config.yml"
    - "echo \"  default_ec2_keyname: null\" >> .elasticbeanstalk/config.yml"
    - "echo \"  default_platform: 64bit Amazon Linux 2016.03 v2.1.0 running Docker 1.9.1\" >> .elasticbeanstalk/config.yml"
    - "echo \"  default_region: eu-west-1\" >> .elasticbeanstalk/config.yml"
    - "echo \"  profile: null\" >> .elasticbeanstalk/config.yml"
    - "echo \"  sc: git\" >> .elasticbeanstalk/config.yml"

deployment:
  hub:
    branch: circle_ci
    commands:
      - eb use ${EB_ENVIRONMENT}
      - eb deploy
