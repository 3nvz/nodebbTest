general:
  branches:
    only:
      - circle_ci
      - production

machine:
  timezone:
    Etc/UTC
  services:
    - docker
  environment:
    RAILS_ENV: test
    RACK_ENV: test
    NEW_RELIC_LOG: stdout
    WEB_CONCURRENCY: 3
    CXX: g++-4.8

dependencies:
  pre:
    - "sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10"
    - "echo 'deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen' | sudo tee /etc/apt/sources.list.d/mongodb.list"
    - "sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv BA9EF27F"
    - "sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test"
    - sudo apt-get update
    - sudo apt-get install mongodb-org-server
    - "sudo apt-get install g++-4.8"
    - npm i --production
    - database=mongo mongo__database=${APP_MONGO_DATABASE} mongo__username=${APP_MONGO_USERNAME} mongo__password=${APP_MONGO_PASSWORD} mongo__host=${APP_MONGO_HOST} mongo__port=${APP_MONGO_PORT} mongo__options=${APP_MONGO_OPTIONS} admin__username=${APP_ADMIN_USERNAME} admin__password=${APP_ADMIN_PASSWORD} node app --setup

deployment:
  hub:
    branch: circle_ci
    commands:
      - eval $(aws ecr get-login --region eu-west-1)
      - docker build -t proversity-nodebb .
      - docker tag proversity-nodebb:latest 353198996426.dkr.ecr.eu-west-1.amazonaws.com/proversity-nodebb:latest
      - docker push 353198996426.dkr.ecr.eu-west-1.amazonaws.com/proversity-nodebb:latest
